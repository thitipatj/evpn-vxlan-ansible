
system {
    host-name spine-04;
    time-zone America/Los_Angeles;
    root-authentication {
        encrypted-password "$1$ZUlES4dp$OUwWo1g7cLoV/aMWpHUnC/";
    }
    name-server {
        192.168.5.68;
        192.168.60.131;
    }
    services {
        netconf {
            ssh;
        }
        ssh;
    }
    login {
        message "This is the property of Example Corp. Do not login without express permission. ";
    }
    syslog  {
        user * {
            any emergency;
        }
        file messages {
            any notice;
        }
        file cli-commands {
            interactive-commands any;
            explicit-priority;
        }
        time-format millisecond;
    }
    ntp {
        server 172.17.28.5;
    }
}
interfaces {
    fxp0 {
        unit 0 {
            family inet {
              address 0.0.0.0/<subnet mask>;
            }
        }
    }
    lo0 {
        unit 0 {
            family inet {
                address 100.0.0.14/32
            }
        }
    }
}
snmp {
    location "Site 1";
    contact "John Doe";
    community public {
        authorization read-only;
    }
}
routing-options {
  static {
    route 172.0.0.0/8 {
      next-hop 10.94.194.254;
      retain;
      no-readvertise;
    }
  }
}
protocols {
    lldp {
        interface all;
    }
}
/* This block of configuration has been generated by the role overlay-evpn-mx-l3 for Ansible */

protocols {
    bgp {
        group overlay-evpn {
            type internal;
            family evpn signaling;
            local-as 65200;
            local-address 100.0.0.14;
            multipath;
            neighbor 100.0.0.23;
            neighbor 100.0.0.24;
            cluster 3.3.3.3;
        }
        bfd-liveness-detection {
            minimum-interval 350;
            multiplier 3;
            session-mode automatic;
        }
        group overlay-evpn-rr {
            type internal;
            family evpn signaling;
            local-as 65200;
            local-address 100.0.0.14;
            multipath;
            neighbor 100.0.0.11;
            neighbor 100.0.0.12;
            neighbor 100.0.0.13;
        }
    }
}

routing-options {
    router-id 100.0.0.14;
    forwarding-table {
        ecmp-fast-reroute;
    }
}

routing-instances {
    VRF_TENANT_10 {
        instance-type vrf;
        interface lo0.10;
        interface irb.100;
        interface irb.101;
        interface irb.102;
        interface irb.103;
        interface irb.104;
        route-distinguisher 100.0.0.14:10;
        vrf-target target:10:10;
    }
    VS_TENANT_10 {
        instance-type virtual-switch;
        vtep-source-interface lo0.0;
        route-distinguisher 100.0.0.14:10;
        vrf-import VRF_TENANT_10_VS_IN;
        vrf-target target:11:10;
        protocols {
            evpn {
                encapsulation vxlan;
                extended-vni-list [  9100  9101  9102  9103  9104  ];
                multicast-mode ingress-replication;
            }
        }
        bridge-domains {
            bd9100 {
                routing-interface irb.100;
                vlan-id  100;
                vxlan {
                    vni 9100;
                    ingress-node-replication;
                }
            }
            bd9101 {
                routing-interface irb.101;
                vlan-id  101;
                vxlan {
                    vni 9101;
                    ingress-node-replication;
                }
            }
            bd9102 {
                routing-interface irb.102;
                vlan-id  102;
                vxlan {
                    vni 9102;
                    ingress-node-replication;
                }
            }
            bd9103 {
                routing-interface irb.103;
                vlan-id  103;
                vxlan {
                    vni 9103;
                    ingress-node-replication;
                }
            }
            bd9104 {
                routing-interface irb.104;
                vlan-id  104;
                vxlan {
                    vni 9104;
                    ingress-node-replication;
                }
            }
        }
    }
    VRF_TENANT_11 {
        instance-type vrf;
        interface lo0.11;
        interface irb.105;
        interface irb.106;
        interface irb.107;
        interface irb.108;
        interface irb.109;
        route-distinguisher 100.0.0.14:11;
        vrf-target target:10:11;
    }
    VS_TENANT_11 {
        instance-type virtual-switch;
        vtep-source-interface lo0.0;
        route-distinguisher 100.0.0.14:11;
        vrf-import VRF_TENANT_11_VS_IN;
        vrf-target target:11:11;
        protocols {
            evpn {
                encapsulation vxlan;
                extended-vni-list [  9105  9106  9107  9108  9109  ];
                multicast-mode ingress-replication;
            }
        }
        bridge-domains {
            bd9105 {
                routing-interface irb.105;
                vlan-id  105;
                vxlan {
                    vni 9105;
                    ingress-node-replication;
                }
            }
            bd9106 {
                routing-interface irb.106;
                vlan-id  106;
                vxlan {
                    vni 9106;
                    ingress-node-replication;
                }
            }
            bd9107 {
                routing-interface irb.107;
                vlan-id  107;
                vxlan {
                    vni 9107;
                    ingress-node-replication;
                }
            }
            bd9108 {
                routing-interface irb.108;
                vlan-id  108;
                vxlan {
                    vni 9108;
                    ingress-node-replication;
                }
            }
            bd9109 {
                routing-interface irb.109;
                vlan-id  109;
                vxlan {
                    vni 9109;
                    ingress-node-replication;
                }
            }
        }
    }
}


interfaces {
    irb {
        unit 100 {
            description " * TENANT 10 - vlan 100 - vni 9100 "
            family inet {
                address 10.0.1.14/24 {
                    virtual-gateway-address 10.0.1.1;
                }
            }
        }
        unit 101 {
            description " * TENANT 10 - vlan 101 - vni 9101 "
            family inet {
                address 10.0.2.14/24 {
                    virtual-gateway-address 10.0.2.1;
                }
            }
        }
        unit 102 {
            description " * TENANT 10 - vlan 102 - vni 9102 "
            family inet {
                address 10.0.3.14/24 {
                    virtual-gateway-address 10.0.3.1;
                }
            }
        }
        unit 103 {
            description " * TENANT 10 - vlan 103 - vni 9103 "
            family inet {
                address 10.0.4.14/24 {
                    virtual-gateway-address 10.0.4.1;
                }
            }
        }
        unit 104 {
            description " * TENANT 10 - vlan 104 - vni 9104 "
            family inet {
                address 10.0.5.14/24 {
                    virtual-gateway-address 10.0.5.1;
                }
            }
        }
        unit 105 {
            description " * TENANT 11 - vlan 105 - vni 9105 "
            family inet {
                address 10.0.6.14/24 {
                    virtual-gateway-address 10.0.6.1;
                }
            }
        }
        unit 106 {
            description " * TENANT 11 - vlan 106 - vni 9106 "
            family inet {
                address 10.0.7.14/24 {
                    virtual-gateway-address 10.0.7.1;
                }
            }
        }
        unit 107 {
            description " * TENANT 11 - vlan 107 - vni 9107 "
            family inet {
                address 10.0.8.14/24 {
                    virtual-gateway-address 10.0.8.1;
                }
            }
        }
        unit 108 {
            description " * TENANT 11 - vlan 108 - vni 9108 "
            family inet {
                address 10.0.9.14/24 {
                    virtual-gateway-address 10.0.9.1;
                }
            }
        }
        unit 109 {
            description " * TENANT 11 - vlan 109 - vni 9109 "
            family inet {
                address 10.0.10.14/24 {
                    virtual-gateway-address 10.0.10.1;
                }
            }
        }
    }
    lo0 {
        unit 10 {
            family inet {
                address 101.0.10.14/32;
            }
        }
    }
    lo0 {
        unit 11 {
            family inet {
                address 101.0.11.14/32;
            }
        }
    }
}

policy-options {
    policy-statement VRF_TENANT_10_VS_IN {
        term import_leaf_esi {
            from community comm-leaf_esi;
            then accept;
        }
        term import_vni9100 {
            from community com9100;
            then accept;
        }
        term import_vni9101 {
            from community com9101;
            then accept;
        }
        term import_vni9102 {
            from community com9102;
            then accept;
        }
        term import_vni9103 {
            from community com9103;
            then accept;
        }
        term import_vni9104 {
            from community com9104;
            then accept;
        }
        term default {
            then reject;
        }
    }
    policy-statement VRF_TENANT_11_VS_IN {
        term import_leaf_esi {
            from community comm-leaf_esi;
            then accept;
        }
        term import_vni9105 {
            from community com9105;
            then accept;
        }
        term import_vni9106 {
            from community com9106;
            then accept;
        }
        term import_vni9107 {
            from community com9107;
            then accept;
        }
        term import_vni9108 {
            from community com9108;
            then accept;
        }
        term import_vni9109 {
            from community com9109;
            then accept;
        }
        term default {
            then reject;
        }
    }
    community com9100 members target:1:9100;
    community com9101 members target:1:9101;
    community com9102 members target:1:9102;
    community com9103 members target:1:9103;
    community com9104 members target:1:9104;
    community com9105 members target:1:9105;
    community com9106 members target:1:9106;
    community com9107 members target:1:9107;
    community com9108 members target:1:9108;
    community com9109 members target:1:9109;
    community comm-leaf_esi members target:9999:9999;
}
/* This block of configuration has been generated by the role underlay-ebgp for Ansible */

interfaces {
    et-0/0/66 {
        description " * to leaf-03";
        mtu 9192;
        unit 0 {
            family inet {
                mtu 9000;
                address 172.16.0.28/31;
            }
        }
    }
    et-0/0/67 {
        description " * to leaf-04";
        mtu 9192;
        unit 0 {
            family inet {
                mtu 9000;
                address 172.16.0.30/31;
            }
        }
    }
    et-0/0/61 {
        description " * to fabric-01";
        mtu 9192;
        unit 0 {
            family inet {
                mtu 9000;
                address 172.16.0.20/31;
            }
        }
    }
    et-0/0/60 {
        description " * to fabric-02";
        mtu 9192;
        unit 0 {
            family inet {
                mtu 9000;
                address 172.16.0.22/31;
            }
        }
    }
}

protocols {
    bgp {
        log-updown;
        graceful-restart;
        group underlay-ipfabric {
            import bgp-ipclos-in;
            export  bgp-ipclos-out;
            type external;
            mtu-discovery;
            local-as 65014;
            bfd-liveness-detection {
                minimum-interval 350;
                multiplier 3;
                session-mode automatic;
            }
            multipath multiple-as;
            neighbor 172.16.0.29 {
                peer-as 65023;
            }
            neighbor 172.16.0.31 {
                peer-as 65024;
            }
            neighbor 172.16.0.21 {
                peer-as 65001;
            }
            neighbor 172.16.0.23 {
                peer-as 65002;
            }
        }
    }
}

routing-options {
    router-id 100.0.0.14;
    forwarding-table {
        export pfe-ecmp;
    }
}

policy-options {
    policy-statement pfe-ecmp {
        then {
            load-balance per-packet;
        }
    }
    policy-statement bgp-ipclos-in {
        term loopbacks {
            from {
                route-filter 100.0.0.0/16 orlonger;
            }
            then accept;
        }
    }
    policy-statement bgp-ipclos-out {
        term loopback {
            from {
                protocol direct;
                route-filter 100.0.0.14/32 orlonger;
            }
            then {
                community add MYCOMMUNITY;
                next-hop self;
                accept;
            }
        }
        term as-path {
            from {
                as-path asPathLength2;
                community MYCOMMUNITY;
            }
            then reject;
        }
    }
    as-path asPathLength2 ".{2,}";
    community MYCOMMUNITY members target:12345:222;
}
