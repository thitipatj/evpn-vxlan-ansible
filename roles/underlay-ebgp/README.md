
# 'underlay-ebgp' role

Generate the base configuration to build an IP Fabric with EBGP:
 - Point to Point IP per interface
 - Underlay BGP configuration using EBGP
 - BFD for BGP on all interfaces
 - BGP policy options
 - ECMP across Spines

Template can be found in [roles/underlay-ebgp/templates/main.conf.j2 ](templates/main.conf.j2)

## Variables Needed by this role

```yaml

# Global parameters
build_dir:            # Repository used save config generated by this role

# Per device parameters
loopback_ip:          # Loopback ip in the defaul VRF, used as VTEP address

underlay:
## User provided parameters
    local:
        asn: 				    # Local ASN configured for the underlay on the device
    neighbors:
      - interface:	    # Interface connected to a remote peer in the IP Fabric
        name: 			    # Hostname of the connected device (useful for comment)
        remote_interface: 	# Remote interface connected to our device
        asn:				    # ASN of the remote device
        peer_ip:		  	# Directly connected IP address of the remote device (DO NOT USE LOOPBACK since it is IP fabric)
        local_ip:			  # Local IP address configured on directly connected interface
      - interface:			# Interface connected to a remote peer in the IP Fabric
        name: 				  # Hostname of the connected device (useful for comment)
        remote_interface: 	# Remote interface connected to our device
        asn:				    # ASN of the remote device
        peer_ip:			  # Directly connected IP address of the remote device (DO NOT USE LOOPBACK since it is IP fabric)
        local_ip:			  # Local IP address configured on directly connected interface

## Default parameters
## All default parameters are available [here](defaults/main.yaml)
    mtu_phy_int:        # MTU of physical interfaces
    mtu_logical_int:    # MTU of logical interfaces
    network_size:       # Network Size for P2P link
    bfd:                # Configuration for BFD
      min_interval:     
      multiplier:
      mode:
    networks:           # Network information used to build policy
      loopbacks:
      underlay:
## Optional Parameters based on devices roles
    advertize_local_only: # Recommended for Leaf to avoid re advertising other loopback
    community:            # Recommended for Spine in Multi-pod topology
```

### Example

This template have been designed to used a variable structure mainly composed of hash/dict.  
Leveraging Ansible option to *merge hash*, it become possible to have all required information coming from different variable files, in order to reduce data duplication.

- group_vars/*group_name*/underlay-ebgp.yaml   > Information shared across devices
- host_vars/*device_name*/underlay-ebgp.yaml   > information specific to single device



**For Group 'all'**
```yaml
# group_vars/all/underlay-ebgp.yaml
underlay:
    networks:
        loopbacks: 100.0.0.0/16
        underlay: 172.16.0.0/12

```

**For Group 'leaf'**
```yaml
# group_vars/leaf/overlay.yaml
underlay:
    advertize_local_only: true
```

**For Device 'qfx5100'**
```yaml
# host_vars/qfx5100/underlay-ebgp.yaml
underlay:
    local:
        asn: 60010
    neighbors:
      - interface: ge-0/0/0
        name: Peer A hostname
        asn: 60001
        peer_ip: 171.0.0.0
        local_ip: 171.0.0.1
      - interface:  ge-0/0/1
        name: Peer B hostname
        asn: 60002
        peer_ip: 171.0.0.8
        local_ip: 171.0.0.9
```
