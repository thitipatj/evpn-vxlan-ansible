/* This block of configuration has been generated by the role overlay-evpn-mx-l3 for Ansible */

protocols {
    bgp {
{# BGP peering configuration for EVPN #}
        group overlay-evpn {
            type internal;
            family evpn signaling;
            local-as {{ overlay.local.asn }};
            local-address {{ loopback_ip }};
            multipath;
{% for neighbor in overlay.neighbors %}
            neighbor {{neighbor}};
{% endfor %}
{# If Device is configured as Route Reflector #}
{% if overlay.local.cluster is defined %}
            cluster {{ overlay.local.cluster }};
{% endif %}
        }
        bfd-liveness-detection {
            minimum-interval {{ overlay.bfd.min_interval }};
            multiplier {{ overlay.bfd.multiplier }};
            session-mode {{ overlay.bfd.mode }};
        }
{# If Device is configured as Route Reflector #}
{% if overlay.local.cluster is defined %}
        group overlay-evpn-rr {
            type internal;
            family evpn signaling;
            local-as {{ overlay.local.asn }};
            local-address {{ loopback_ip }};
            multipath;
{% for neighbor in overlay.rr_bgp %}
            neighbor {{neighbor}};
{% endfor %}
        }
{% endif %}
    }
}

routing-options {
    router-id {{ loopback_ip }};
    forwarding-table {
        ecmp-fast-reroute;
    }
}

routing-instances {
{% for name, tenant in overlay.tenants.items() %}
{# L3 Routing Instance for IRB inside VXLAN tunnel, one per tenant #}
    VRF_TENANT_{{tenant.id}} {
        instance-type vrf;
        interface lo0.{{tenant.id}};
{% for bd in tenant.bridge_domains %}
{% if bd.local_ip is defined %}
        interface irb.{{ bd.vlan_id }};
{% endif %}
{% endfor %}
        route-distinguisher {{ loopback_ip }}:{{tenant.id}};
        vrf-target target:10:{{tenant.id}};
    }
{# L2 Routing Instance per tenant #}
    VS_TENANT_{{tenant.id}} {
        instance-type virtual-switch;
        vtep-source-interface lo0.0;
        route-distinguisher {{ loopback_ip }}:{{tenant.id}};
        vrf-import VRF_TENANT_{{tenant.id}}_VS_IN;
        vrf-target target:11:{{tenant.id}};
        protocols {
            evpn {
                encapsulation vxlan;
                extended-vni-list [ {% for bd in tenant.bridge_domains %} {{ bd.vni_id }} {% endfor %} ];
                multicast-mode ingress-replication;
            }
        }
        bridge-domains {
{% for bd in tenant.bridge_domains %}
            bd{{ bd.vni_id }} {
{% if bd.local_ip is defined %}
                routing-interface irb.{{ bd.vlan_id }};
{% endif %}
                vlan-id  {{ bd.vlan_id }};
                vxlan {
                    vni {{ bd.vni_id }};
                    ingress-node-replication;
                }
            }
{% endfor %}
        }
    }
{% endfor %}
}


interfaces {
{# Configuration for Anycast Gateway / IRB #}
    irb {
{% for name, tenant in overlay.tenants.items() %}
{% for bd in tenant.bridge_domains %}
{% if bd.local_ip is defined %}
        unit {{ bd.vlan_id }} {
            description " * TENANT {{tenant.id}} - vlan {{bd.vlan_id}} - vni {{bd.vni_id}} "
            family inet {
                address {{ bd.local_ip }}/{{ bd.mask }} {
                    virtual-gateway-address {{ bd.vip_ip }};
                }
            }
        }
{% endif %}
{% endfor %}
{% endfor %}
    }
{# Configuration for Loopback per VRF #}
{% for name, tenant in overlay.tenants.items() %}
    lo0 {
        unit {{tenant.id}} {
            family inet {
                address {{ tenant.lo0_ip }}/32;
            }
        }
    }
{% endfor %}
}

policy-options {
{% for name, tenant in overlay.tenants.items() %}
    policy-statement VRF_TENANT_{{tenant.id}}_VS_IN {
        term import_leaf_esi {
            from community comm-leaf_esi;
            then accept;
        }
{% for bd in tenant.bridge_domains %}
        term import_vni{{ bd.vni_id }} {
            from community com{{ bd.vni_id }};
            then accept;
        }
{% endfor %}
        term default {
            then reject;
        }
    }
{% endfor %}
{% for name, tenant in overlay.tenants.items() %}
{% for bd in tenant.bridge_domains %}
    community com{{ bd.vni_id }} members target:1:{{ bd.vni_id }};
{% endfor %}
{% endfor %}
    community comm-leaf_esi members target:9999:9999;
}
